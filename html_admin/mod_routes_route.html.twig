{% extends 'layout_default.html.twig' %}

{% block meta_title %}{{ route.name }} - {{ 'Routes'|trans }}{% endblock %}

{% block content %}
<div class="route-detail">
    <div class="h-block">
        <div class="h-block-header">
            <div class="icon"><span class="big-light-icon i-location"></span></div>
            <h2>{{ route.name }}</h2>
            <p>{{ route.description|default('No description')|nl2br }}</p>
        </div>
        <div class="block">
            
            <!-- Action Buttons -->
            <div style="margin-bottom: 20px;">
                <a href="{{ 'routes'|alink }}" class="btn btn-default">
                    <span class="icon-arrow-left"></span> {{ 'Back to Routes'|trans }}
                </a>
                
                {% if assigned_clients|length > 0 %}
                <a href="{{ 'routes/navigation'|alink }}/{{ route.id }}" class="btn btn-primary">
                    <span class="icon-map"></span> {{ 'View Route Navigation'|trans }}
                </a>
                {% endif %}
            </div>

            <!-- Flag Summary Panel -->
            {% if assigned_clients|length > 0 %}
            <div class="flag-summary-panel" style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                <h3 style="margin-top: 0; color: white;">ðŸ‡ºðŸ‡¸ {{ 'Route Flag Summary'|trans }}</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 6px;">
                        <div style="font-size: 14px; opacity: 0.9;">{{ 'Total US Flags'|trans }}</div>
                        <div style="font-size: 32px; font-weight: bold; margin-top: 5px;">{{ flag_summary.total_us_flags }}</div>
                    </div>
                    {% if flag_summary.flag_types|length > 0 %}
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 6px;">
                        <div style="font-size: 14px; opacity: 0.9;">{{ 'Flag Types'|trans }}</div>
                        <div style="margin-top: 10px;">
                            {% for type, count in flag_summary.flag_types %}
                            <div style="margin-bottom: 5px;">
                                <strong>{{ type }}:</strong> {{ count }} {{ 'location(s)'|trans }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% if flag_summary.flag_sizes|length > 0 %}
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 6px;">
                        <div style="font-size: 14px; opacity: 0.9;">{{ 'Flag Sizes'|trans }}</div>
                        <div style="margin-top: 10px;">
                            {% for size, count in flag_summary.flag_sizes %}
                            <div style="margin-bottom: 5px;">
                                <strong>{{ size }}:</strong> {{ count }} {{ 'location(s)'|trans }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Assigned Clients Section -->
            <div class="tab-content">
                <h3>{{ 'Assigned Clients'|trans }} ({{ assigned_clients|length }})</h3>
                
                {% if assigned_clients|length > 0 %}
                <table class="table" id="assigned-clients-table">
                    <thead>
                        <tr>
                            <th>{{ 'Client Name'|trans }}</th>
                            <th>{{ 'Email'|trans }}</th>
                            <th>{{ 'Address'|trans }}</th>
                            <th>{{ 'Order Info'|trans }}</th>
                            <th>{{ 'Flags'|trans }}</th>
                            <th>{{ 'Service Instructions'|trans }}</th>
                            <th>{{ 'Actions'|trans }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in assigned_clients %}
                        <tr>
                            <td>
                                <a href="{{ 'client/manage'|alink }}/{{ client.client_id }}" target="_blank">
                                    <strong>{{ client.first_name }} {{ client.last_name }}</strong>
                                </a>
                            </td>
                            <td>{{ client.email }}</td>
                            <td>{{ client.address|default('N/A') }}</td>
                            <td>
                                {% if client.order_details %}
                                    <div><strong>{{ client.order_details.title }}</strong></div>
                                    {% if client.order_addons|length > 0 %}
                                    <div style="font-size: 12px; color: #666;">
                                        <strong>Addons:</strong>
                                        {% for addon in client.order_addons %}
                                            <br>â€¢ {{ addon.title }}{% if addon.quantity > 1 %} ({{ addon.quantity }}){% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <span class="badge badge-secondary">{{ 'No Order'|trans }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if client.flag_info|length > 0 %}
                                    {% for key, value in client.flag_info %}
                                        <div style="font-size: 12px; white-space: nowrap;">
                                            <strong>{{ key }}:</strong> {{ value }}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                            <td style="max-width: 200px;">
                                {% if client.service_instructions %}
                                    <div style="font-size: 12px; max-height: 60px; overflow-y: auto;">
                                        {{ client.service_instructions }}
                                    </div>
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <form method="post" action="{{ 'routes/remove'|alink }}" style="display: inline;" onsubmit="return confirm('Remove this client from the route?');">
                                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
                                    <input type="hidden" name="client_id" value="{{ client.client_id }}">
                                    <input type="hidden" name="route_id" value="{{ route.id }}">
                                    <button type="submit" class="btn btn-small btn-danger">
                                        {{ 'Remove'|trans }}
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="help">
                    <p>{{ 'No clients assigned to this route yet. Assign clients from the unassigned list below.'|trans }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Unassigned Clients Section -->
            <div class="tab-content" style="margin-top: 40px;">
                <h3>{{ 'Unassigned Clients'|trans }} ({{ unassigned_clients|length }})</h3>
                
                {% if unassigned_clients|length > 0 %}
                <div style="margin-bottom: 15px;">
                    <input type="text" id="searchUnassigned" class="form-control" placeholder="{{ 'Search unassigned clients...'|trans }}" style="max-width: 400px;">
                </div>
                
                <table class="table" id="unassigned-clients-table">
                    <thead>
                        <tr>
                            <th>{{ 'Client Name'|trans }}</th>
                            <th>{{ 'Email'|trans }}</th>
                            <th>{{ 'Address'|trans }}</th>
                            <th>{{ 'Client Group'|trans }}</th>
                            <th>{{ 'Active Order'|trans }}</th>
                            <th>{{ 'Actions'|trans }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in unassigned_clients %}
                        <tr class="unassigned-row">
                            <td>
                                <a href="{{ 'client/manage'|alink }}/{{ client.client_id }}" target="_blank">
                                    <strong>{{ client.first_name }} {{ client.last_name }}</strong>
                                </a>
                            </td>
                            <td>{{ client.email }}</td>
                            <td>{{ client.address|default('N/A') }}</td>
                            <td>{{ client.client_group_name|default('Default') }}</td>
                            <td>
                                {% if client.has_active_order %}
                                    <span class="badge badge-success" title="{{ client.active_order_status }}">
                                        âœ“ {{ client.active_order_status|capitalize }}
                                    </span>
                                {% else %}
                                    <span class="badge badge-secondary">{{ 'No Active Order'|trans }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <form method="post" action="{{ 'routes/assign'|alink }}" style="display: inline;">
                                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
                                    <input type="hidden" name="client_id" value="{{ client.client_id }}">
                                    <input type="hidden" name="route_id" value="{{ route.id }}">
                                    <button type="submit" class="btn btn-small btn-success">
                                        {{ 'Assign to Route'|trans }}
                                    </button>
                                </form>
                                
                                <!-- Quick assign to other routes -->
                                {% if all_routes|length > 1 %}
                                <select onchange="quickAssign(this, {{ client.client_id }})" class="form-control" style="display: inline-block; width: auto; margin-left: 5px;">
                                    <option value="">{{ 'Or assign to...'|trans }}</option>
                                    {% for other_route in all_routes %}
                                        {% if other_route.id != route.id %}
                                        <option value="{{ other_route.id }}">{{ other_route.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="help">
                    <p>{{ 'All clients have been assigned to routes.'|trans }}</p>
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<style>
.badge {
    display: inline-block;
    padding: 3px 7px;
    font-size: 12px;
    font-weight: bold;
    line-height: 1;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 10px;
}

.badge-success {
    background-color: #5cb85c;
}

.badge-secondary {
    background-color: #777;
}

.form-control {
    display: inline-block;
    width: 100%;
    padding: 6px 12px;
    font-size: 14px;
    line-height: 1.42857143;
    color: #555;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
}
</style>

<script>
// Quick assign functionality
function quickAssign(select, clientId) {
    const routeId = select.value;
    if (routeId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ 'routes/assign'|alink }}';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'CSRFToken';
        csrfInput.value = '{{ CSRFToken }}';
        form.appendChild(csrfInput);
        
        const clientInput = document.createElement('input');
        clientInput.type = 'hidden';
        clientInput.name = 'client_id';
        clientInput.value = clientId;
        form.appendChild(clientInput);
        
        const routeInput = document.createElement('input');
        routeInput.type = 'hidden';
        routeInput.name = 'route_id';
        routeInput.value = routeId;
        form.appendChild(routeInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Search functionality for unassigned clients
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchUnassigned');
    if (searchInput) {
        searchInput.addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('.unassigned-row');
            
            rows.forEach(function(row) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }
});
</script>
{% endblock %}
